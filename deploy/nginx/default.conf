server {
  listen 80;
  server_name haejin315.cloud www.haejin315.cloud;

  # 정적 파일 (webchat 프론트가 여기 있다고 가정)
  root /usr/share/nginx/html;
  index index.html;

  # 1) webchat: /webchat 로 들어오면 루트(/)로 rewrite 해서 기존 SPA 그대로 사용
  location = /webchat {
    return 301 /webchat/;
  }
  location /webchat/ {
    rewrite ^/webchat/(.*)$ /$1 break;
    try_files $uri $uri/ /index.html;
  }

  # (선택) 기존 루트도 유지하고 싶으면 그대로 둬도 됨
  location / {
    try_files $uri $uri/ /index.html;
  }

  # 2) WebSocket은 그대로 /ws 사용 (webchat에서 /ws로 붙는다면 문제 없음)
  location /ws {
    proxy_pass http://app:8080;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    proxy_read_timeout 3600;
    proxy_send_timeout 3600;
  }

  # 3) webgame1: 로컬로 프록시 (reverse ssh로 열린 9001로)
  location = /webgame1 { return 301 /webgame1/; }

  location /webgame1/ {
    proxy_pass http://172.17.0.1:9001/;  # ✅ EC2 호스트의 9001(터널)
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
